---
/* src/layouts/BaseLayout.astro */
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import NewsletterModal from "../components/NewsletterModal.astro";

/** PROPS & DEFAULTS (paramétrico por página) */
interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  /** URL absoluta o relativa del canónico; si no, se calcula */
  canonicalURL?: string;
  /** JSON-LD adicional por página (objeto o array) */
  structuredData?: any;
  /** Forzar noindex desde la página (override) */
  noindex?: boolean;
  /** og:type opcional (p.ej. "article" en posts) */
  ogType?: string;
}
const {
  title = "La Doble Bragado",
  description = "La Vuelta Histórica de Ciclismo en Buenos Aires. Más de 500km de recorrido uniendo ciudades bonaerenses. La carrera de ciclismo más antigua de Argentina.",
  ogImage = "/images/og-image-v2.jpg",
  canonicalURL,
  structuredData = null,
  ogType = "website",
  // Staging por defecto en noindex, prod index: ajusta hostname a tu dominio final
  noindex = (import.meta.env.MODE !== "production") || (Astro.url.hostname !== "ladoblebragado.com.ar"),
} = Astro.props;

/* Derivados SEO */
const siteHref = (Astro.site && Astro.site.href) || "https://ladoblebragado.com.ar/"; // TODO: ajustá dominio final
const baseURL = siteHref.endsWith("/") ? siteHref : siteHref + "/";

/** normaliza: quita query/hash y la doble barra final (excepto "/") */
const normalizeUrl = (u: string) => {
  const url = new URL(u, baseURL);
  url.hash = "";
  url.search = "";
  const href = url.href;
  return (href.endsWith("/") && url.pathname !== "/") ? href.slice(0, -1) : href;
};

const seoTitle = (title === "La Doble Bragado")
  ? `${title} — Vuelta histórica de ciclismo en Buenos Aires`
  : `${title} — La Doble Bragado`;

const fullImageURL = new URL(ogImage, baseURL).href;
const currentCanonicalURL = normalizeUrl(canonicalURL ?? new URL(Astro.url.pathname, baseURL).href);

/* ===== JSON-LD por defecto (Organization + WebSite + WebPage + Breadcrumb) ===== */
const orgId = `${baseURL}#organization`;
const websiteId = `${baseURL}#website`;
const webpageId = `${currentCanonicalURL}#webpage`;

const defaultSchemas: any[] = [
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "@id": orgId,
    "name": "La Doble Bragado",
    "url": baseURL,
    "logo": new URL("/images/ldb-logo-v3.svg", baseURL).href, // TODO: confirmar logo definitivo 120x120+
    "sameAs": [
      "https://www.instagram.com/ladoblebragado/",
      "https://www.youtube.com/@ladoblebragado"
      // TODO: agregar otras redes si aplica
    ]
  },
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "@id": websiteId,
    "url": baseURL,
    "name": "La Doble Bragado",
    "inLanguage": "es-AR",
    "publisher": { "@id": orgId },
    "potentialAction": {
      "@type": "SearchAction",
      "target": {
        "@type": "EntryPoint",
        "urlTemplate": `${baseURL}search?q={search_term_string}`
      },
      "query-input": "required name=search_term_string"
    }
  },
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "@id": webpageId,
    "url": currentCanonicalURL,
    "name": seoTitle,
    "description": description,
    "inLanguage": "es-AR",
    "isPartOf": { "@id": websiteId }
  },
  (() => {
    // BreadcrumbList simple: Home > Página (si no es Home)
    const parts = Astro.url.pathname.split("/").filter(Boolean);
    const items = [
      { "@type": "ListItem", "position": 1, "name": "Inicio", "item": baseURL }
    ];
    if (parts.length > 0) {
      items.push({
        "@type": "ListItem",
        "position": 2,
        "name": title,
        "item": currentCanonicalURL
      });
    }
    return {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": items
    };
  })()
];

// Mezcla con schemas específicos de cada página si se pasan por props
const schemasToRender = structuredData
  ? (Array.isArray(structuredData) ? [...defaultSchemas, ...structuredData] : [...defaultSchemas, structuredData])
  : defaultSchemas;

const jsonLd = JSON.stringify(schemasToRender);

/* ===== Ejemplo SportsEvent (dejar comentado para futuras ediciones)
const sportsEventSchema = {
  "@context": "https://schema.org",
  "@type": "SportsEvent",
  "name": "88° Edición de La Doble Bragado",
  "startDate": "2025-02-01", // TODO: fecha real
  "location": {
    "@type": "Place",
    "name": "Bragado, Buenos Aires, Argentina",
    "address": { "@type": "PostalAddress", "addressLocality": "Bragado", "addressRegion": "Buenos Aires", "addressCountry": "AR" }
  }
};
*/
---

<!doctype html>
<html lang="es-AR" class="scroll-smooth" data-theme="masculina">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />

    <title>{seoTitle}</title>
    <meta name="description" content={description} />
    <!-- (Opcional) keywords: poco útil para Google; mantener si tu equipo lo usa -->
    <meta name="keywords" content="ciclismo, carrera, bragado, chivilcoy, 25 de mayo, chacabuco, argentina, deporte, competencia, 500km, oeste bonaerense, ciclismo ruta" />
    <meta name="author" content="La Doble Bragado" />

    <!-- Robots: staging vs prod -->
    <meta name="robots" content={noindex ? "noindex, nofollow, noarchive" : "index, follow"} />

    <!-- Canonical único y normalizado -->
    <link rel="canonical" href={currentCanonicalURL} />

    <!-- Open Graph -->
    <meta property="og:type" content={ogType} />
    <meta property="og:site_name" content="La Doble Bragado" />
    <meta property="og:locale" content="es_AR" />
    <meta property="og:url" content={currentCanonicalURL} />
    <meta property="og:title" content={seoTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={fullImageURL} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="La Doble Bragado, Vuelta de Ciclismo en Buenos Aires" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <!-- TODO: confirmar handle si existe -->
    <meta name="twitter:site" content="@ladoblebragado" />
    <meta name="twitter:creator" content="@ladoblebragado" />
    <meta name="twitter:url" content={currentCanonicalURL} />
    <meta name="twitter:title" content={seoTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={fullImageURL} />
    <meta name="twitter:image:alt" content="La Doble Bragado, Vuelta de Ciclismo en Buenos Aires" />

    <!-- GEO (básico) — Ajustar si usás Bragado u otra ciudad de sede -->
    <meta name="geo.region" content="AR" />
    <meta name="geo.placename" content="Buenos Aires, Argentina" />
    <meta name="geo.position" content="-34.6037;-58.3816" />
    <meta name="ICBM" content="-34.6037, -58.3816" />

    <!-- Favicons / PWA -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#171442" />

    <!-- Rendimiento (fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400..800&family=Audiowide&display=swap" rel="stylesheet" />

    <!-- JSON-LD unificado -->
    <script type="application/ld+json" set:html={jsonLd}></script>
  </head>

  <body class="font-sans bg-white antialiased">
    <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-amarillo text-oscuro px-3 py-2 rounded-lg z-50">
      Saltar al contenido
    </a>

    <Header />

    <main id="main" role="main">
      <slot />
    </main>

    <Footer />
    <NewsletterModal />
  </body>
</html>
